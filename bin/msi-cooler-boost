#!/usr/bin/env bash

SERVICE="mcontrolcenter.helper"
INTERFACE="dmitry_s93.MControlCenter"
ADDRESS=152
ON_VALUE=128
OFF_VALUE=0

ON_THRESHOLD=82
OFF_THRESHOLD=60
INTERVAL=5

NOTIFY_ID=99123

LOCKFILE="/tmp/cooler-boost.lock"
exec 9>"$LOCKFILE"
if ! flock -n 9; then
  exit 0
fi

trap 'rm -f "$LOCKFILE"; exit' EXIT INT TERM

QDBUS="$(command -v qdbus 2>/dev/null || true)"
[ -z "$QDBUS" ] && exit 0

FIRST_RUN=true

notify_state() {
  notify-send "Cooler Boost: $1"
}

is_ec_loaded() {
  $QDBUS --system "$SERVICE" / "$INTERFACE.isEcSysModuleLoaded" 2>/dev/null | grep -qi true
}

load_ec() {
  $QDBUS --system "$SERVICE" / "$INTERFACE.loadEcSysModule" >/dev/null 2>&1
}

cb_set() {
  $QDBUS --system "$SERVICE" / "$INTERFACE.putValue" "$ADDRESS" "$1" >/dev/null 2>&1
}

read_temp_max() {
  local max=-1000 val
  shopt -s nullglob
  for f in /sys/class/thermal/thermal_zone*/temp; do
    read -r val <"$f" || continue
    if [ "$val" -gt 1000 ]; then
      val=$((val / 1000))
    fi
    [ "$val" -gt "$max" ] && max="$val"
  done
  [ "$max" -eq -1000 ] && echo "" || echo "$max"
}

service_ready() {
  $QDBUS --system "$SERVICE" / org.freedesktop.DBus.Peer.Ping >/dev/null 2>&1
}

if service_ready; then
  is_ec_loaded || load_ec
fi

cleanup() {
  cb_set "$OFF_VALUE"
}
trap cleanup EXIT

state="unknown"

sleep 3

while :; do
  if ! service_ready; then
    sleep "$INTERVAL"
    continue
  fi

  is_ec_loaded || load_ec

  temp="$(read_temp_max)"
  if [ -z "$temp" ]; then
    sleep "$INTERVAL"
    continue
  fi

  if [ "$temp" -ge "$ON_THRESHOLD" ]; then
    if [ "$state" != "on" ]; then
      if cb_set "$ON_VALUE"; then
        state="on"
        notify_state "ON"
        FIRST_RUN=false
      fi
    fi
  elif [ "$temp" -le "$OFF_THRESHOLD" ]; then
    if [ "$state" != "off" ]; then
      if cb_set "$OFF_VALUE"; then
        state="off"
        if [ "$FIRST_RUN" = false ]; then
          notify_state "OFF"
        else
          FIRST_RUN=false
        fi
      fi
    fi
  fi

  sleep "$INTERVAL"
done
